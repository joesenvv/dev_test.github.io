<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MongoDB 读写要点 | wudaijun&#39;s blog</title>
  <meta name="author" content="wudaijun">
  
  <meta name="description" content="一. 查询1.1 “多段式”查询当执行find操作的时候，只是返回一个游标，并不立即查询数据库，这样在执行之前可以给查询附加额外选项。几乎所有游标对象的方法都返回游标本身，因此可以按任意顺序组成方法链。以下查询是等价的：
&amp;gt; var cursor = db.foo.find().sort({&quot;x&quot;:1}).limit(1).skip(10)
&amp;gt; var cursor = db.foo.find().limit(1).sort({&quot;x&quot;:1}).skip(10)
&amp;gt; var cursor = db.foo.find().skip(10).limit(1).sort({&quot;x&quot;:1})
此时，我们只是构造了一个查询，并没有执行实际操作，当我们执行：
&amp;gt; cursor.hasNext()
这时，查询被发往服务器，sell立即获取第一个块(前101个文档或前1M数据，取其小者)，这样下次调用next或hasNext时，就不必再次向服务器发起一次查询。客户端用完了第一组结果，shell会再次向服务器获取下一组结果(大小不超过4MB)， 直至结果全部返回。可通过batchSize设置游标返回的块的文档数量。
注：如果在shell中，没有将返回的游标赋给一个var，shell将自动迭代游标20次，显示出前20调记录。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="MongoDB 读写要点"/>
  <meta property="og:site_name" content="wudaijun&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="wudaijun&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <meta name="wumiiVerification" content="fb50a101-84fe-4ca2-91a7-ae8cf792978b" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
  <header id="header" class="inner"><div class= "header-content">
	<div class = "alignleft col-one">
		
			<img src = "/assets/avatar/avatar.png">
		
		<div class="header-div">
		    <h1><a href="/", style="font-family:Fantasy">wudaijun&#39;s blog</a></h1>
		    <h2><a href="/">Coding is Funny</a></h2>
		</div>
	</div>
	<div class = "alignright col-two">
		
			<img src = "/assets/avatar/hello.jpg">
		
	</div>
	<div class="clearfix"></div>
</div>

<div class= "header-nav">
	<div id="main-nav" class="alignleft">
	    
	      <a href="/">首页</a>
	    
	      <a href="/archives">归档</a>
	    
	</div>
	<div id="sub-nav" class="alignright">
	    
	      <a href="/about">关于我</a>
	    
	</div>
	<div class="clearfix"></div>
</div>
</header>
  
      <div id="content" class="inner">
  		<div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        <time datetime="2016-06-22T16:00:00.000Z"><a href="/2016/06/mongodb-read-write/">2016-06-23</a></time>
        
  
    <h1 class="title">MongoDB 读写要点</h1>
  

    </header>
    <div class="entry">
      
        <div id="toc" class="toc-article">
	<div class="toc-title">目录</div>
	<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-_查询"><span class="toc-text">一. 查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1_“多段式”查询"><span class="toc-text">1.1 “多段式”查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2_快照查询"><span class="toc-text">1.2 快照查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3_游标释放"><span class="toc-text">1.3 游标释放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4_cursor-explain()"><span class="toc-text">1.4 cursor.explain()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5_读取策略"><span class="toc-text">1.5 读取策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6_其它查询技巧"><span class="toc-text">1.6 其它查询技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-_写入"><span class="toc-text">二. 写入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_写入策略"><span class="toc-text">2.1 写入策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考："><span class="toc-text">参考：</span></a></li></ol>
</div>
      
        <h2 id="一-_查询">一. 查询</h2><h3 id="1-1_“多段式”查询">1.1 “多段式”查询</h3><p>当执行find操作的时候，只是返回一个游标，并不立即查询数据库，这样在执行之前可以给查询附加额外选项。几乎所有游标对象的方法都返回游标本身，因此可以按任意顺序组成方法链。以下查询是等价的：</p>
<pre><code>&gt; <span class="tag">var</span> <span class="attribute">cursor</span> = db<span class="class">.foo</span><span class="class">.find</span>().<span class="function"><span class="title">sort</span><span class="params">({<span class="string">"x"</span>:<span class="number">1</span>})</span></span>.<span class="function"><span class="title">limit</span><span class="params">(<span class="number">1</span>)</span></span>.<span class="function"><span class="title">skip</span><span class="params">(<span class="number">10</span>)</span></span>
&gt; <span class="tag">var</span> <span class="attribute">cursor</span> = db<span class="class">.foo</span><span class="class">.find</span>().<span class="function"><span class="title">limit</span><span class="params">(<span class="number">1</span>)</span></span>.<span class="function"><span class="title">sort</span><span class="params">({<span class="string">"x"</span>:<span class="number">1</span>})</span></span>.<span class="function"><span class="title">skip</span><span class="params">(<span class="number">10</span>)</span></span>
&gt; <span class="tag">var</span> <span class="attribute">cursor</span> = db<span class="class">.foo</span><span class="class">.find</span>().<span class="function"><span class="title">skip</span><span class="params">(<span class="number">10</span>)</span></span>.<span class="function"><span class="title">limit</span><span class="params">(<span class="number">1</span>)</span></span>.<span class="function"><span class="title">sort</span><span class="params">({<span class="string">"x"</span>:<span class="number">1</span>})</span></span>
</code></pre><p>此时，我们只是构造了一个查询，并没有执行实际操作，当我们执行：</p>
<pre><code>&gt; <span class="attribute">cursor</span>.<span class="function"><span class="title">hasNext</span><span class="params">()</span></span>
</code></pre><p>这时，查询被发往服务器，sell立即获取第一个块(前101个文档或前1M数据，取其小者)，这样下次调用next或hasNext时，就不必再次向服务器发起一次查询。客户端用完了第一组结果，shell会再次向服务器获取下一组结果(大小不超过4MB)， 直至结果全部返回。可通过<a href="https://docs.mongodb.com/manual/reference/method/cursor.batchSize/#cursor.batchSize" target="_blank" rel="external">batchSize</a>设置游标返回的块的文档数量。</p>
<p>注：如果在shell中，没有将返回的游标赋给一个var，shell将自动迭代游标20次，显示出前20调记录。</p>
<a id="more"></a>
<h3 id="1-2_快照查询">1.2 快照查询</h3><p>由于find()操作是<strong>多段式</strong>的，集合在游标查询的过程中，文档可能由于大小改变而发生了移动，比如某个文档由于增大，超过了原来分配的空间，导致文档被移动到集合的末尾处，此时使用游标查询可能会再次返回这些被移动的文档。解决方案是对查询进行<a href="https://docs.mongodb.com/manual/reference/method/cursor.snapshot/" target="_blank" rel="external">快照</a>:</p>
<pre><code>&gt; db<span class="class">.foo</span><span class="class">.find</span>().<span class="function"><span class="title">snapshot</span><span class="params">()</span></span>
</code></pre><h3 id="1-3_游标释放">1.3 游标释放</h3><p>前面看到的游标都是客户端游标，每个客户端游标对应一个数据库游标，数据库游标会占用服务器资源，因此合理地尽快地释放游标是有必要的。以下几种情况将会释放数据库游标：</p>
<ul>
<li>客户端主动发起关闭游标请求</li>
<li>游标迭代完匹配结果</li>
<li>客户端游标不在作用域(客户端游标被析构/GC)，会向服务器发送消息销毁对应数据库游标</li>
<li>游标10分钟未被使用，数据库游标会自动销毁，可通过<a href="https://docs.mongodb.com/manual/reference/method/cursor.noCursorTimeout/#cursor.noCursorTimeout" target="_blank" rel="external">noCursorTimeout</a>(注意和<a href="https://docs.mongodb.com/manual/reference/method/cursor.maxTimeMS/" target="_blank" rel="external">maxTimeMS</a>的区别)取消游标超时</li>
</ul>
<h3 id="1-4_cursor-explain()">1.4 cursor.explain()</h3><p>游标的另一个很有用的函数是explain()，它能够提供<code>db.collection.find()</code>操作的详尽分析，包括</p>
<ul>
<li>查询方案的决策：使用和何种方案(如使用哪个索引)，查询方向</li>
<li>执行结果分析：扫描了多少文档，多少个索引条目，花费时间等</li>
<li>服务器信息：地址，端口，版本等</li>
<li>分片信息：如果集合使用了分片，还会列出访问了哪个分片，即对应的分片信息</li>
</ul>
<p>这些信息对于开发期间的查询性能分析和索引的对比性测试是非常有帮助的，关于它的详细解释，参见[cursor.explain()][]官方文档。</p>
<h3 id="1-5_读取策略">1.5 读取策略</h3><p>在目前最新的MongoDB 3.2版本中，新加了读取策略(<a href="https://docs.mongodb.com/manual/reference/read-concern/" target="_blank" rel="external">ReadConcern</a>)，支持local和majority两种策略，前者直接读取当前的MongoDB实例，但是可能会读到副本集中不一致的数据，甚至可能回滚。majority策略读取那些已经被副本集大多数成员所认可的数据，因此数据不可能被回滚。目前majority只被<a href="https://docs.mongodb.com/manual/core/WiredTiger/" target="_blank" rel="external">WiredTiger</a>存储引擎所支持。</p>
<h3 id="1-6_其它查询技巧">1.6 其它查询技巧</h3><ol>
<li>不要使用skip()来实现分页，这样每次都会查询所有文档，可利用每页最后一个文档中的key作为查询条件来获取下一页。</li>
<li>获取随机文档，不要先将所有的文档都找出来，然后再随机。而是为所有的文档加一个随机Key，每次查询{“$gte”:randomkey}或{“$lt”:randomkey}即可</li>
<li>MongoDB对内嵌文档的支持非常完善，可通过{“key1.key2”: value2}直接查询内嵌文档，也可以在内嵌文档Key上建立索引</li>
</ol>
<h2 id="二-_写入">二. 写入</h2><h3 id="2-1_写入策略">2.1 写入策略</h3><p>MongoDB支持灵活的写入策略(<a href="https://docs.mongodb.com/manual/reference/write-concern/" target="_blank" rel="external">WriteConcern</a>):</p>
<p>用法：<code>db.collection.insert({x:1}, {writeConcern:{w:1,j:false}})</code></p>
<ol>
<li>w: 数据写入到number个节点才向客户端确认<ul>
<li>{w: 0}: 对客户端的写入不需要发送任何确认，适用于性能要求较高，但不关注正确性的场景</li>
<li>{w: 1}: 默认的写入策略，数据写入到Primary就向客户端发送确认</li>
<li>{w: “majority”}: 数据写入到副本集大多数成员后向客户端发送确认，适用于对数据安全性要求高的场景，但会降低写入性能</li>
</ul>
</li>
<li>j: 写入操作的journal持久化后才向客户端确认(需要w选项所指定的节点均已写入journal)，默认为false。</li>
<li>wtimeout: 写入超时时间，仅当w选项的值大于1才有效，当写入过程出现节点故障，无法满足w选项的条件时，超过wtimeout时间，则认定写入失败。</li>
</ol>
<p>关于写入策略的具体实现，参见：<a href="http://www.mongoing.com/archives/2916" target="_blank" rel="external">http://www.mongoing.com/archives/2916</a></p>
<h2 id="参考：">参考：</h2><p>MongoDB CURD概念： <a href="https://docs.mongodb.com/manual/core/crud/" target="_blank" rel="external">https://docs.mongodb.com/manual/core/crud/</a></p>

      
    </div>
    <footer>
<!--        -->
        
  
  <div class="categories">
    <a href="/categories/database/">database</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/mongodb/">mongodb</a>
  </div>

        
<!--        -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
<!--   <h1 class="title">留言</h1> -->


    <!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="2016/06/mongodb-read-write/" data-title="MongoDB 读写要点" data-url="http://wudaijun.com/2016/06/mongodb-read-write/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"wudaijun"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->


  
</section>



</div></div>
  		<aside id="sidebar" class="alignright">
   <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:wudaijun.com">
  </form>
</div> 

  
<div class="widget tag">
  <h3 class="title">分类</h3>
<!--   
	
		<li><a href="/categories/c-c/">c/c++</a><small>6</small></li>
	
  
	
		<li><a href="/categories/database/">database</a><small>4</small></li>
	
  
	
		<li><a href="/categories/erlang/">erlang</a><small>23</small></li>
	
  
	
		<li><a href="/categories/gameserver/">gameserver</a><small>16</small></li>
	
  
	
		<li><a href="/categories/go/">go</a><small>2</small></li>
	
  
	
		<li><a href="/categories/lua/">lua</a><small>2</small></li>
	
  
	
		<li><a href="/categories/network/">network</a><small>3</small></li>
	
  
	
		<li><a href="/categories/os/">os</a><small>3</small></li>
	
  
	
		<li><a href="/categories/other/">other</a><small>1</small></li>
	
  
	
		<li><a href="/categories/python/">python</a><small>1</small></li>
	
  
	
		<li><a href="/categories/tool/">tool</a><small>3</small></li>
	
  
	
		<li><a href="/categories/unity/">unity</a><small>3</small></li>
	
  
	
		<li><a href="/categories/web/">web</a><small>1</small></li>
	
   -->
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/c-c/">c/c++</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gameserver/">gameserver</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/os/">os</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unity/">unity</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">1</span></li></ul> 
</div>
 


  
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">2016年09月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">2016年08月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">2016年07月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">2016年06月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">2016年05月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">2016年04月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">2016年03月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">2016年02月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">2016年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">2015年12月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">2015年11月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">2015年10月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">2015年09月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">2015年08月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">2015年07月</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">2015年06月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">2015年05月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">2015年04月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">2015年03月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">2015年02月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">2015年01月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">2014年12月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">2014年11月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">2014年10月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">2014年09月</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/c-c/" style="font-size: 15.71px;">c/c++</a> <a href="/tags/distribution/" style="font-size: 14.29px;">distribution</a> <a href="/tags/erlang/" style="font-size: 20px;">erlang</a> <a href="/tags/firefly/" style="font-size: 11.43px;">firefly</a> <a href="/tags/gameserver/" style="font-size: 10px;">gameserver</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/go/" style="font-size: 11.43px;">go</a> <a href="/tags/goa/" style="font-size: 10px;">goa</a> <a href="/tags/kbengine/" style="font-size: 11.43px;">kbengine</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/lua/" style="font-size: 17.14px;">lua</a> <a href="/tags/mongodb/" style="font-size: 14.29px;">mongodb</a> <a href="/tags/ngserver/" style="font-size: 18.57px;">ngserver</a> <a href="/tags/os/" style="font-size: 11.43px;">os</a> <a href="/tags/other/" style="font-size: 10px;">other</a> <a href="/tags/python/" style="font-size: 14.29px;">python</a> <a href="/tags/skynet/" style="font-size: 14.29px;">skynet</a> <a href="/tags/tcp-ip/" style="font-size: 12.86px;">tcp/ip</a> <a href="/tags/tool/" style="font-size: 11.43px;">tool</a> <a href="/tags/unity/" style="font-size: 12.86px;">unity</a> <a href="/tags/web/" style="font-size: 10px;">web</a>
  </div>
</div>

</aside>
           <div class="clearfix"></div>
      </div>
  	
   <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 wudaijun
  
</div>
<div class="alignright">
	<a href="https://github.com/pengloo53/light-ch">Hexo theme</a>
</div>
<div class="clearfix"></div></footer>
  <script src="http://libs.baidu.com/jquery/2.1.1/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?380ce5c81e06b297c4a75c0c66825c3d";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<div id="toTop">
	<a href="#">▲</a>
	<a href="#footer">▼</a>
</div>
<!--  -->


</body>
</html>