<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>谈谈GS对象的落地 | wudaijun's blog</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">谈谈GS对象的落地</h1><a id="logo" href="/.">wudaijun's blog</a><p class="description">Coding is Funny</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">谈谈GS对象的落地</h1><div class="post-meta"><a href="/2018/06/gs-model-save/#comments" class="comment-count"></a><p><span class="date">Jun 20, 2018</span><span><a href="/categories/gameserver/" class="category">gameserver</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>现在的游戏服务器通常使用NoSQL作为DB以满足Model设计上的灵活性，特别是即将到来的<a href="https://docs.mongodb.com/master/release-notes/4.0/" target="_blank" rel="external">MongoDB 4.0</a>将提供多文档事务支持，这意味着，SQL转向NoSQL的最后障碍已经被消除。</p>
<p>理想的MongoDB使用场景是将单个对象映射为单个文档，比如玩家数据，公会数据等，但一方面MongoDB对单文档大小硬限制为16M，另一方面，我们需要根据对象更新频度，固有特性等进一步优化，提高DB性能。这里简单谈谈那些GS对象落地的方方面面。</p>
<a id="more"></a>
<h3 id="一-存储方案"><a href="#一-存储方案" class="headerlink" title="一. 存储方案"></a>一. 存储方案</h3><h4 id="1-单文档"><a href="#1-单文档" class="headerlink" title="1. 单文档"></a>1. 单文档</h4><p>最简单的模型，将对象放在一个文档中，需要能够预估对象空间占用总量，比如玩家数据，单服内所有已经使用的玩家名字等。</p>
<h4 id="2-分组保存"><a href="#2-分组保存" class="headerlink" title="2. 分组保存"></a>2. 分组保存</h4><p>将N个小对象分为M个文档保存，可以按照逻辑或者底层统一划分，比如简单按照<code>对象ID%M</code>得到，这种方案主要用于减少文档数量(文档数量对MongoDB序列化时间的影响是比较可观的)。分组保存主要有两种更新方式：基于$set/$unset的增量式更新(GroupSet)，以及基于文档的覆写更新(GroupWrite)。</p>
<h4 id="3-GridFS"><a href="#3-GridFS" class="headerlink" title="3. GridFS"></a>3. GridFS</h4><p>MongoDB GridFS用于以二进制格式保存大文件，这种方案的优点的简单，将数据整块打包为二进制即可。缺点也很明显:</p>
<ol>
<li>对大对象的序列化时间通常较长(毫秒级别)</li>
<li>二进制存储，DB对运维运营和数据分析不友好</li>
<li>GridFS只能覆写，也就和读写优化搭不上边了</li>
</ol>
<p>因此通常我不建议在GS中使用GridFS。</p>
<h3 id="二-存储优化"><a href="#二-存储优化" class="headerlink" title="二. 存储优化"></a>二. 存储优化</h3><h4 id="1-批量读写"><a href="#1-批量读写" class="headerlink" title="1. 批量读写"></a>1. 批量读写</h4><p>这个是DB操作层的优化，用于提高落地效率，主流的MongoDB驱动都提供的批量操作接口。</p>
<h4 id="2-脏标记"><a href="#2-脏标记" class="headerlink" title="2. 脏标记"></a>2. 脏标记</h4><p>这是逻辑层的优化，主要用于减少和DB不必要的交互。脏标记控制对对象的写操作，对对象打上脏标记。主要用于不常变动的对象，比如玩家Cache，但针对数据结构复杂的对象，维护脏标记状态的工作量就比较大了，否则可能漏存数据。脏标记通常需要语言或框架层有访问控制或Hook机制(提供统一的修改入口)。另外就是脏标记本身有一定的不一致性风险，比如DB操作失败，但脏标记已被清除。</p>
<h4 id="3-初始标记"><a href="#3-初始标记" class="headerlink" title="3. 初始标记"></a>3. 初始标记</h4><p>和脏标记类似，但主要用于减少DB数据量，提升加载效率。Origin标记用于判断一个对象是否是初始状态，如果是初始状态，则不写入DB，当DB加载时，通过配置生成这些Origin对象。比如SLG大地图上的格子，通常SLG大地图绝大部分格子都处于初始状态(未被占领)，因此这类对象通过初始标记优化，可以极大程度提升地图加载效率。当一个格子由初始状态被占领时，该格子落地，当这个格子被玩家放弃回到初始状态时，这个格子被删掉。这个功能在调试期间很有用，在线上也能帮助服务器平滑过渡峰值(开服期间人多，但需要落地的地少，后期地多，但人少)。</p>
<h4 id="4-局部更新"><a href="#4-局部更新" class="headerlink" title="4. 局部更新"></a>4. 局部更新</h4><p>针对比较复杂的对象，比如玩家，公会，对其子模块进行局部脏标记并局部更新(mongodb $set)，和脏标记一样，这减少了DB交互。但是通常用得不多，主要原因一是和脏标记一样，需要语言框架的支持，二是粒度不好把控，粒度太细会导致开发负担增大，带来的弊大于利。</p>
<h3 id="三-存储时机"><a href="#三-存储时机" class="headerlink" title="三. 存储时机"></a>三. 存储时机</h3><h4 id="1-定时落地"><a href="#1-定时落地" class="headerlink" title="1. 定时落地"></a>1. 定时落地</h4><p>GS中大部分的对象并不需要实时地将更新写入DB，只需要每隔一段时间(Tick，通常几分钟)落地即可。定时落地通常会结合分组落地(每次Tick只落地一个分组)，脏标记等优化方案。</p>
<h4 id="2-实时落地"><a href="#2-实时落地" class="headerlink" title="2. 实时落地"></a>2. 实时落地</h4><p>对于少数关键数据，比如支付订单，通常是实时落地的，即数据产生或变更时立即写入数据库。</p>
<h4 id="3-停服落地"><a href="#3-停服落地" class="headerlink" title="3. 停服落地"></a>3. 停服落地</h4><p>停服落地通常会与定时落地不同，为了数据安全性，停服落地可以采用刷盘操作，以再一次确保DB数据一致性。</p>
<h3 id="四-DB交互"><a href="#四-DB交互" class="headerlink" title="四. DB交互"></a>四. DB交互</h3><h4 id="1-同异步"><a href="#1-同异步" class="headerlink" title="1. 同异步"></a>1. 同异步</h4><p>DB交互本质上是外部IO交互，应该放到单独的DB线程中去完成，正常情况下，逻辑线程与DB线程只能异步交互，但在开服和停服逻辑中，为了简化流程，可以同步加载/落地。</p>
<h4 id="2-时序性"><a href="#2-时序性" class="headerlink" title="2. 时序性"></a>2. 时序性</h4><p>为了提升DB模块的效率，通常我们会开个DB Worker Pool来完成实际的DB工作，但要考虑到同一个调用方的多个DB请求的时序性保证，最简单的实现是将来自同一个逻辑模块的DB请求全部交给同一个DB Worker来完成。</p>
<h4 id="3-深拷贝"><a href="#3-深拷贝" class="headerlink" title="3. 深拷贝"></a>3. 深拷贝</h4><p>由于对象需要交由DB模块来落地，因此需要对对象深拷贝(同步保存不需要)，也可以直接序列化为Bson之后再交给DB模块。</p>
<h4 id="4-事务支持"><a href="#4-事务支持" class="headerlink" title="4. 事务支持"></a>4. 事务支持</h4><p>就我目前的开发经验而言，GS逻辑中基本是用不到事务的，或者说，需要用到事务的地方，都可以通过其它方式绕过去，大部分时候，GS都只是将DB作为内存持久化工具，进行单文档读写操作，用不到复杂的多文档事务。</p>
<h3 id="五-总结"><a href="#五-总结" class="headerlink" title="五. 总结"></a>五. 总结</h3><p>这里只是简单提了下DB落地需要考虑的方方面面，在Model层设计上，应该赋予对象存储足够的灵活性，让对象自己根据存储时机，同异步去选择自己的存储方案和存储优化，对通用的存储方案，应该尽量抽象它们的操作，比如批量写，分组保存等。设计准则仍然是开发效率和灵活度优先，然后再是优化层面。具体实现上，还要结合具体的语言框架，比如对Go语言来说，由于其访问控制很弱，也没有Hook机制，因此对对象做脏标记要谨慎。</p>
</div><div class="tags"><a href="/tags/gameserver/">gameserver</a></div><div class="post-share"></div><div class="post-nav"><a href="/2018/06/consistent-hashing/" class="next">一致Hash算法</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zMzg3Ni8xMDQyOQ=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一-存储方案"><span class="toc-text">一. 存储方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-单文档"><span class="toc-text">1. 单文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-分组保存"><span class="toc-text">2. 分组保存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-GridFS"><span class="toc-text">3. GridFS</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二-存储优化"><span class="toc-text">二. 存储优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-批量读写"><span class="toc-text">1. 批量读写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-脏标记"><span class="toc-text">2. 脏标记</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-初始标记"><span class="toc-text">3. 初始标记</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-局部更新"><span class="toc-text">4. 局部更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三-存储时机"><span class="toc-text">三. 存储时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-定时落地"><span class="toc-text">1. 定时落地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-实时落地"><span class="toc-text">2. 实时落地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-停服落地"><span class="toc-text">3. 停服落地</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四-DB交互"><span class="toc-text">四. DB交互</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-同异步"><span class="toc-text">1. 同异步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-时序性"><span class="toc-text">2. 时序性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-深拷贝"><span class="toc-text">3. 深拷贝</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-事务支持"><span class="toc-text">4. 事务支持</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#五-总结"><span class="toc-text">五. 总结</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/gs-model-save/">谈谈GS对象的落地</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/consistent-hashing/">一致Hash算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/flux-study/">Flux - Web应用的数据流管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/react-notes/">React - Web中的函数式思维</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/understand-functional-programing/">理解函数式编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/go-pprof/">go pprof 性能分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/docker-container-ops/">Docker 容器管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/docker-management/">Docker容器编排工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/go-sync-map-implement/">Go sync.Map 实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/go-interface-implement/">Go Interface 实现</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c/">c/c++</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gameserver/">gameserver</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/os/">os</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programing/">programing</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/system/">system</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unity/">unity</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/ngserver/" style="font-size: 15px;">ngserver</a> <a href="/tags/lua/" style="font-size: 15px;">lua</a> <a href="/tags/skynet/" style="font-size: 15px;">skynet</a> <a href="/tags/erlang/" style="font-size: 15px;">erlang</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/firefly/" style="font-size: 15px;">firefly</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/kbengine/" style="font-size: 15px;">kbengine</a> <a href="/tags/distribution/" style="font-size: 15px;">distribution</a> <a href="/tags/unity/" style="font-size: 15px;">unity</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/c-c/" style="font-size: 15px;">c/c++</a> <a href="/tags/os/" style="font-size: 15px;">os</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/gameserver/" style="font-size: 15px;">gameserver</a> <a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/goa/" style="font-size: 15px;">goa</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/system/" style="font-size: 15px;">system</a> <a href="/tags/macosx/" style="font-size: 15px;">macosx</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/programing/" style="font-size: 15px;">programing</a> <a href="/tags/hash/" style="font-size: 15px;">hash</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">二月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">wudaijun.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>