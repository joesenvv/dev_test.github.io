<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Firefly 学习(一) | wudaijun&#39;s blog | Coding is Funny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="firefly,python">
  <meta name="description" content="一. 简介firefly是一款python开发的开源游戏服务器框架，基于分布式，底层使用twisted。">
<meta property="og:type" content="article">
<meta property="og:title" content="Firefly 学习(一)">
<meta property="og:url" content="http://wudaijun.com/2015/05/firefly-study1/index.html">
<meta property="og:site_name" content="wudaijun's blog">
<meta property="og:description" content="一. 简介firefly是一款python开发的开源游戏服务器框架，基于分布式，底层使用twisted。">
<meta property="og:image" content="http://wudaijun.com/assets/image/firefly_nodes.png">
<meta property="og:updated_time" content="2016-09-20T14:51:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Firefly 学习(一)">
<meta name="twitter:description" content="一. 简介firefly是一款python开发的开源游戏服务器框架，基于分布式，底层使用twisted。">
  
    <link rel="alternative" href="/atom.xml" title="wudaijun&#39;s blog" type="application/atom+xml">
  
  <meta name="summary" content="&lt;h2 id=&quot;一-_简介&quot;&gt;一. 简介&lt;/h2&gt;&lt;p&gt;firefly是一款python开发的开源游戏服务器框架，基于分布式，底层使用twisted。&lt;/p&gt;">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/favicon.png"></a>
      <hgroup class="introduce">
        <h5 class="nickname">wudaijun</h5>
        <a href="mailto:wdjlost@gmail.com" title="wdjlost@gmail.com" class="mail">wdjlost@gmail.com</a>
      </hgroup>
    </div>
  </div>
  <div class="scroll-wrap flex-col">
    <ul class="nav">
      
          <li class="waves-block waves-effect">
            <a href="/"  >
              <i class="icon icon-lg icon-home"></i>
              Home
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/archives"  >
              <i class="icon icon-lg icon-archives"></i>
              Archives
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/tags"  >
              <i class="icon icon-lg icon-tags"></i>
              Tags
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="https://github.com/wudaijun" target="_blank" >
              <i class="icon icon-lg icon-github"></i>
              Github
            </a>
          </li>
      
    </ul>

    <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>wudaijun&#39;s blog &copy; 2016</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

  </div>
</div>

  </nav>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Firefly 学习(一)</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">Firefly 学习(一)</h1>
    <h5 class="subtitle">
        
            <time datetime="2015-05-19T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2015-05-20
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/gameserver/">gameserver</a></li></ul>

        
    </h5>
  </div>
</header>

    <div class="container body-wrap">
      <article id="post-firefly-study1" 
  class="article article-type-post" itemprop="blogPost">
    <div class="post-meta flex-row">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/firefly/">firefly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </div>
    <div class="post-body">
        <aside class="post-widget" id="post-widget">

            

            
            <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一-_简介"><span class="post-toc-text">一. 简介</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#二-_使用"><span class="post-toc-text">二. 使用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-_流程"><span class="post-toc-text">1. 流程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-_配置文件"><span class="post-toc-text">2. 配置文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#master节点"><span class="post-toc-text">master节点</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分布式节点"><span class="post-toc-text">分布式节点</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-_公共入口"><span class="post-toc-text">3. 公共入口</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-_节点实现"><span class="post-toc-text">4. 节点实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-_总结"><span class="post-toc-text">6. 总结</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#三-_实现原理"><span class="post-toc-text">三. 实现原理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-master启动"><span class="post-toc-text">1.master启动</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-FFServer"><span class="post-toc-text">2.FFServer</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-_待续"><span class="post-toc-text">3. 待续</span></a></li></ol></li></ol>
            </nav>
            
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="一-_简介">一. 简介</h2><p>firefly是一款python开发的开源游戏服务器框架，基于分布式，底层使用twisted。</p>
<a id="more"></a>
<p>具体介绍可参见：</p>
<ul>
<li><a href="firefly_on_git">firefly on github</a></li>
<li><a href="firefly_9miao">firefly官网</a></li>
<li><a href="firefly_doc">firefly官方Wiki</a></li>
</ul>
<p>firefly采用多进程方案，节点之间通过网络通信(当然你也可以创建单节点，独立完成大部分功能)，具有很好的可扩展性。</p>
<h2 id="二-_使用">二. 使用</h2><p>作为一个Python初学者，下面只谈一些自己对firefly的一些肤浅认识。上面的途径可以获取到更完整和深入的资料。</p>
<p>下面的Demo的源代码可在<a href="demo_github">我的Github</a>上下载。</p>
<h3 id="1-_流程">1. 流程</h3><p>总体上看，如果你要使用firefly，所需要做的事就是：</p>
<ul>
<li>通过配置文件定义所有节点，节点配置，节点实现文件，以及节点和节点之间的联系(通过网络端口)</li>
<li>定义节点实现文件</li>
<li>启动主节点</li>
</ul>
<p>firefly通过配置文件来设定你的分布式服务器，然后你只需创建和启动master节点，master服务器会启动配置文件中的各个子节点：</p>
<pre><code><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:
    from firefly<span class="class">.master</span><span class="class">.master</span> import Master
    master = <span class="function"><span class="title">Master</span><span class="params">()</span></span>
    master.<span class="function"><span class="title">config</span><span class="params">(<span class="string">'config.json'</span>,<span class="string">'appmain.py'</span>)</span></span>
    master.<span class="function"><span class="title">start</span><span class="params">()</span></span>
</code></pre><p>config.json定义你的分布式服务，appmain.py是你的子节点公共入口，master节点已在master.start()中启动。</p>
<h3 id="2-_配置文件">2. 配置文件</h3><p>下面是一份 config.json 实例，该配置文件配置了一个无盘节点，即没有使用数据库:</p>
<pre><code>{
"<span class="attribute">master</span>":<span class="value">{"<span class="attribute">rootport</span>":<span class="value"><span class="number">9999</span></span>,"<span class="attribute">webport</span>":<span class="value"><span class="number">9998</span></span>}</span>,
"<span class="attribute">servers</span>":<span class="value">{
    "<span class="attribute">gate</span>":<span class="value">{"<span class="attribute">name</span>":<span class="value"><span class="string">"gate"</span></span>, "<span class="attribute">rootport</span>":<span class="value"><span class="number">10000</span></span>, "<span class="attribute">app</span>":<span class="value"><span class="string">"app.gateserver"</span></span>}</span>,
    "<span class="attribute">net</span>":<span class="value">{"<span class="attribute">name</span>":<span class="value"><span class="string">"net"</span></span>, "<span class="attribute">netport</span>":<span class="value"><span class="number">10001</span></span>, "<span class="attribute">name</span>":<span class="value"><span class="string">"net"</span></span>, "<span class="attribute">remoteport</span>":<span class="value">[{"<span class="attribute">rootport</span>":<span class="value"><span class="number">10000</span></span>, "<span class="attribute">rootname</span>":<span class="value"><span class="string">"gate"</span></span>}]</span>, "<span class="attribute">app</span>":<span class="value"><span class="string">"app.netserver"</span></span>}</span>,
    "<span class="attribute">game1</span>":<span class="value">{"<span class="attribute">name</span>":<span class="value"><span class="string">"game1"</span></span>, "<span class="attribute">remoteport</span>":<span class="value">[{"<span class="attribute">rootport</span>":<span class="value"><span class="number">10000</span></span>, "<span class="attribute">rootname</span>":<span class="value"><span class="string">"gate"</span></span>}]</span>, "<span class="attribute">app</span>":<span class="value"><span class="string">"app.game1server"</span></span>}
</span>}
</span>}
</code></pre><p>通过配置文件已经能够很清楚地看懂该服务器的整个分布式情况：</p>
<p><img src="/assets/image/firefly_nodes.png" alt="" title="firefly的分布式节点"></p>
<h4 id="master节点">master节点</h4><p>master节点管理所有的节点，它有两个端口rootport和webport，顾名思义，rootport用于和和服务器中其它节点通信，webport用于后台管理，如关闭和重启所有子节点。调用master.start()后，框架会自动创建master节点并监听rootport和webport端口，后者通过<a href="flask">Flask</a>实现。</p>
<h4 id="分布式节点">分布式节点</h4><p>如果将master节点称为整个服务器的根节点，那么servers中定义的节点即为分布式节点，样例config中定义了四个分布式节点，gate, dbfront, net, game1。每个节点都可以定义自己的父节点(通过remoteport，可有多个父节点)，并且关联节点的实现文件(位于config所在目录 app/*.py)。其中gate是net和game1的父节点，意味着如果有网络消息需要game1节点处理，那么消息将由net-&gt;gate-&gt;game1，同理消息响应途径为：game1-&gt;gate-&gt;net。</p>
<h3 id="3-_公共入口">3. 公共入口</h3><p>appmain是我们定义的节点公共入口，它会由firefly通过<code>python appmain.py 节点名 配置路径</code>调用，节点名即为gate, dbfront, net, game1之一，配置路径即为 config.json。该入口允许我们对各分布式节点做一些预先特殊处理，在Demo的appmain.py中，仅仅是读取必须配置，通过一个firefly导出的统一节点类来启动节点:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">本模块在启动master时作为参数传入</span><br><span class="line">firefly会在每个Server(除了master)启动时都调用该模块:</span><br><span class="line">    cmds = 'python %s %s %s'%(self.mainpath, sername, self.configpath) [位于master/master.py, 其中self.mainpath即为本模块] </span><br><span class="line">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json, sys</span><br><span class="line"><span class="keyword">from</span> firefly.server.server <span class="keyword">import</span> FFServer</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    args = sys.argv</span><br><span class="line">    servername = <span class="keyword">None</span></span><br><span class="line">    config = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">if</span> len(args) &gt; <span class="number">2</span>:</span><br><span class="line">        servername = servername = args[<span class="number">1</span>]</span><br><span class="line">        config = json.load(open(args[<span class="number">2</span>], <span class="string">'r'</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError</span><br><span class="line"></span><br><span class="line">    dbconf = config.get(<span class="string">'db'</span>, &#123;&#125;)</span><br><span class="line">    memconf = config.get(<span class="string">'memcached'</span>, &#123;&#125;)</span><br><span class="line">    servsconf = config.get(<span class="string">'servers'</span>, &#123;&#125;)</span><br><span class="line">    masterconf = config.get(<span class="string">'master'</span>,&#123;&#125;)</span><br><span class="line">    serverconf = servsconf.get(servername)</span><br><span class="line">    server = FFServer()</span><br><span class="line">    server.config(serverconf, dbconfig=dbconf, memconfig=memconf, masterconf=masterconf)</span><br><span class="line">    <span class="keyword">print</span> servername, <span class="string">'start'</span></span><br><span class="line">    server.start()</span><br><span class="line">    <span class="keyword">print</span> servername, <span class="string">'stop'</span></span><br></pre></td></tr></table></figure>
<p>appmain.py通过firefly的FFServer来启动节点，这里先不管FFServer如何区分各个节点。至此，我们的分布式服务器就算是启动了。</p>
<h3 id="4-_节点实现">4. 节点实现</h3><p>最后需要我们关心的，就是节点实现了，不用多说，FFServer会根据你传入的节点实现文件，来实现节点的功能。而实际上我们需要做的事情是很少的，因为启动服务器，监听端口，节点间通信，甚至网络消息编解码等等这些功能，FFServer都帮你做了，后面会提到它如何区分和实现这些功能。</p>
<p>而我们要做的，就是通过装饰器响应消息就OK了，并且节点之间的消息转发也很方便：</p>
<p><strong>netserver实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> firefly.server.globalobject <span class="keyword">import</span> GlobalObject, netserviceHandle</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">netservice 默认是 CommandService:</span><br><span class="line">    netservice = services.CommandService("netservice")  [位于server/server.py]</span><br><span class="line">    CommandService 的消息响应函数格式为: HandleName_CommandID(conn, data)</span><br><span class="line">    CommandService 会通过'_'解析出CommandID并注册HandleName_CommandId为其消息响应函数</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="decorator">@netserviceHandle</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">netHandle_100</span><span class="params">(_conn, data)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"netHandle_100: "</span>, data</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"netHandle_100 completed"</span></span><br><span class="line"></span><br><span class="line"><span class="decorator">@netserviceHandle</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">netHandle_200</span><span class="params">(_conn, data)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"netHandle_200: "</span>, data, <span class="string">"forward to gate"</span></span><br><span class="line">    <span class="comment"># 转发到 gateserver.gateHandle1</span></span><br><span class="line">    <span class="comment"># 通过 GlobalObject().remote[父节点名]来得到父节点的远程调用对象</span></span><br><span class="line">    <span class="keyword">return</span> GlobalObject().remote[<span class="string">'gate'</span>].callRemote(<span class="string">'gateHandle1'</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@netserviceHandle</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">netHandle_300</span><span class="params">(_conn, data)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"netHandle_300: "</span>, data, <span class="string">"forward to gate"</span></span><br><span class="line">    <span class="keyword">return</span> GlobalObject().remote[<span class="string">'gate'</span>].callRemote(<span class="string">'gateHandle2'</span>, data)</span><br></pre></td></tr></table></figure>
<p><strong>gateserver实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> firefly.server.globalobject <span class="keyword">import</span> GlobalObject, rootserviceHandle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="decorator">@rootserviceHandle</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gateHandle1</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"gateHandle: "</span>, data</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"gateHandle Completed"</span></span><br><span class="line"></span><br><span class="line"><span class="decorator">@rootserviceHandle</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gateHandle2</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"gateHandle2: "</span>, data, <span class="string">"forward to game1: "</span></span><br><span class="line">    <span class="comment"># 转发到 game1.game1Handle</span></span><br><span class="line">    <span class="comment"># 通过 GlobalObject().root.callChild(节点名，节点函数，参数)远程调用孩子节点</span></span><br><span class="line">    <span class="keyword">return</span> GlobalObject().root.callChild(<span class="string">"game1"</span>, <span class="string">"game1Handle"</span>, data)</span><br></pre></td></tr></table></figure>
<p><strong>game1server实现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> firefly.server.globalobject <span class="keyword">import</span> GlobalObject, remoteserviceHandle</span><br><span class="line"></span><br><span class="line"><span class="decorator">@remoteserviceHandle("gate")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game1Handle</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"game1Handle: "</span>, data</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"game1Handle completed"</span></span><br></pre></td></tr></table></figure>
<p>运行Demo，启动测试客户端，得到结果:</p>
<p>Server端: </p>
<pre><code>[firefly.netconnect.protoc.LiberateFactory] Client <span class="number">0</span> login <span class="keyword">in</span>.[<span class="number">127.0</span>.<span class="number">0.1</span>,<span class="number">61752</span>]
[LiberateProtocol,<span class="number">0</span>,<span class="number">127.0</span>.<span class="number">0.1</span>] call <span class="function"><span class="keyword">method</span> <span class="title">netHandle_100</span> <span class="title">on</span> <span class="title">service</span>[<span class="title">single</span>]
[<span class="title">LiberateProtocol</span>,0,127.0.0.1] <span class="title">netHandle_100</span>:</span>  msgdata
[LiberateProtocol,<span class="number">0</span>,<span class="number">127.0</span>.<span class="number">0.1</span>] call <span class="function"><span class="keyword">method</span> <span class="title">netHandle_200</span> <span class="title">on</span> <span class="title">service</span>[<span class="title">single</span>]
[<span class="title">LiberateProtocol</span>,0,127.0.0.1] <span class="title">netHandle_200</span>:</span>  msgdata <span class="keyword">forward</span> <span class="keyword">to</span> gate
[BilateralBroker,<span class="number">0</span>,<span class="number">127.0</span>.<span class="number">0.1</span>] call <span class="function"><span class="keyword">method</span> <span class="title">gateHandle1</span> <span class="title">on</span> <span class="title">service</span>[<span class="title">single</span>]
[<span class="title">BilateralBroker</span>,0,127.0.0.1] <span class="title">gateHandle</span>:</span>  msgdata
[LiberateProtocol,<span class="number">0</span>,<span class="number">127.0</span>.<span class="number">0.1</span>] call <span class="function"><span class="keyword">method</span> <span class="title">netHandle_300</span> <span class="title">on</span> <span class="title">service</span>[<span class="title">single</span>]
[<span class="title">LiberateProtocol</span>,0,127.0.0.1] <span class="title">netHandle_300</span>:</span>  msgdata <span class="keyword">forward</span> <span class="keyword">to</span> gate
[BilateralBroker,<span class="number">0</span>,<span class="number">127.0</span>.<span class="number">0.1</span>] call <span class="function"><span class="keyword">method</span> <span class="title">gateHandle2</span> <span class="title">on</span> <span class="title">service</span>[<span class="title">single</span>]
[<span class="title">BilateralBroker</span>,0,127.0.0.1] <span class="title">gateHandle2</span>:</span>  msgdata <span class="keyword">forward</span> <span class="keyword">to</span> game1:
[Broker,client] call <span class="function"><span class="keyword">method</span> <span class="title">game1Handle</span> <span class="title">on</span> <span class="title">service</span>[<span class="title">single</span>]
[<span class="title">Broker</span>,<span class="title">client</span>] <span class="title">game1Handle</span>:</span>  msgdata
[LiberateProtocol,<span class="number">0</span>,<span class="number">127.0</span>.<span class="number">0.1</span>] Client <span class="number">0</span> login <span class="keyword">out</span>.
</code></pre><p>Client端:</p>
<pre><code><span class="code">----------------
send commandId: 100
netHandle_100 completed
----------------</span>
send commandId: 200
<span class="header">gateHandle Completed
----------------</span>
send commandId: 300
game1Handle completed
</code></pre><h3 id="6-_总结">6. 总结</h3><p>看起来，使用firefly确实很简单，通过配置文件即可完成强大的分布式部署，节点之间的通信协议，节点间消息以及网络消息的编解码，甚至重连机制框架都已经帮你完成。你只需通过python装饰器，来实现自己的请求响应逻辑即可。</p>
<h2 id="三-_实现原理">三. 实现原理</h2><p>简单梳理一下firefly内部替我们完成的事。</p>
<h3 id="1-master启动">1.master启动</h3><p>在我们的app入口文件中，通过master.start()启动服务器，master.start()完成了:</p>
<ul>
<li>创建一个PBRoot 在rootport监听其它节点连接</li>
<li>创建一个Flask  在webport 监听管理员命令</li>
<li>遍历配置中的servers 通过<code>python appmain.py 节点名 配置文件</code>启动各个分布式节点，appmain.py由使用者编写和提供</li>
</ul>
<h3 id="2-FFServer">2.FFServer</h3><p>在appmain.py中，通过FFServer来创建和启动一个节点，firefly FFServer抽象一个服务进程，前面曾提到过，由于所有非master节点都通过FFServer启动，那么FFServer如何区分各节点功能和通讯协议？ 答案很简单，FFServer检查节点各项配置，为各项配置创建对应的组件，其中比较重要的有:</p>
<ul>
<li>webport 代表该节点希望提供web服务，FFServer通过Flask启动一个简单的web server</li>
<li>rootport 代表该节点是一个父节点，创建并启动PBRoot类(master也有一个PBRoot成员)来监听其它节点的连接 </li>
<li>netport 代表该节点希望接收客户端网络数据，FFServer创建LiberateFactory并监听netport，LiberateFactory中包含对网络数据的解码</li>
<li>db 若该配置为true，FFServer会根据config中的db配置连接到DB</li>
<li>mem 若该配置为true，FFServer会根据config中的memcached配置连接到memchache</li>
<li>remoteport, FFServer为每个父节点创建RemoteObject，并保存remote[name] -&gt; RemoteObject 映射</li>
</ul>
<p>这样，一个节点可以灵活分配一个或多个职责，并且每份职责通过独立的类来处理内部逻辑和通信协议等。除此之外，FFServer还做了两件事：</p>
<ul>
<li>import 节点关联的实现文件，该实现文件通过装饰器可以导入消息回调函数。</li>
<li>连接master节点</li>
</ul>
<h3 id="3-_待续">3. 待续</h3>

            
            
            <blockquote>
                <p>
                本文地址：
                <a href="http://wudaijun.com/2015/05/firefly-study1/" target="_blank" rel="external">http://wudaijun.com/2015/05/firefly-study1/</a>
                </p>
                <footer><cite><a href="http://wudaijun.com">@wudaijun's blog</a></cite></footer>
            </blockquote>
            </div>
            
<nav class="post-nav">
  
    <div class="waves-block waves-effect prev fl">
      <a href="/2015/05/twisted/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Twisted</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2015/05/wordpress-setup/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">WordPress搭建历程</h4>
      </a>
    </div>
  
</nav>


            
            
<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="firefly-study1" data-title="Firefly 学习(一)" data-url="http://wudaijun.com/2015/05/firefly-study1/index.html"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"wudaijun"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





        </div>
    </div>
</article>
    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js" type="text/javascript"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/js/search.js" type="text/javascript"></script>





<script src="//s95.cnzz.com/z_stat.php?id=1254033667&web_id=1254033667"></script>





</body>
</html>
