<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Erlang 服务器落地机制 | wudaijun&#39;s blog</title>
  <meta name="author" content="wudaijun">
  
  <meta name="description" content="游戏服务器中用得最多的就是gen_server，比如游戏中的Player进程，由于gen_server提供的完善的进程设施，我们无需过多地担心进程崩溃而造成的数据丢失的问题(至少还有个terminate用于做善后工作)。因此在进行数据写回时，可以通过定时写回的机制来减轻数据库负担。这一点也是C服务器望尘莫及的。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Erlang 服务器落地机制"/>
  <meta property="og:site_name" content="wudaijun&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="wudaijun&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <meta name="wumiiVerification" content="fb50a101-84fe-4ca2-91a7-ae8cf792978b" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
  <header id="header" class="inner"><div class= "header-content">
	<div class = "alignleft col-one">
		
			<img src = "/assets/avatar/avatar.png">
		
		<div class="header-div">
		    <h1><a href="/", style="font-family:Fantasy">wudaijun&#39;s blog</a></h1>
		    <h2><a href="/">学习让人安静,充实</a></h2>
		</div>
	</div>
	<div class = "alignright col-two">
		
			<img src = "/assets/avatar/hello.jpg">
		
	</div>
	<div class="clearfix"></div>
</div>

<div class= "header-nav">
	<div id="main-nav" class="alignleft">
	    
	      <a href="/">首页</a>
	    
	      <a href="/archives">归档</a>
	    
	</div>
	<div id="sub-nav" class="alignright">
	    
	      <a href="/about">关于我</a>
	    
	</div>
	<div class="clearfix"></div>
</div>
</header>
  
      <div id="content" class="inner">
  		<div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        <time datetime="2015-05-07T16:00:00.000Z"><a href="/2015/05/erlang-gameserver-persistence/">2015-05-08</a></time>
        
  
    <h1 class="title">Erlang 服务器落地机制</h1>
  

    </header>
    <div class="entry">
      
        <div id="toc" class="toc-article">
	<div class="toc-title">目录</div>
	<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#落地流程"><span class="toc-text">落地流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现机制"><span class="toc-text">实现机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#player_model"><span class="toc-text">player_model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#state"><span class="toc-text">state</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据加载"><span class="toc-text">数据加载</span></a></li></ol>
</div>
      
        <p>游戏服务器中用得最多的就是gen_server，比如游戏中的Player进程，由于gen_server提供的完善的进程设施，我们无需过多地担心进程崩溃而造成的数据丢失的问题(至少还有个terminate用于做善后工作)。因此在进行数据写回时，可以通过定时写回的机制来减轻数据库负担。这一点也是C服务器望尘莫及的。</p>
<a id="more"></a>
<h2 id="落地流程">落地流程</h2><p>落地时机应由PlayerManager触发，PlayerManager管理所有的Player进程，每隔一段时间进行数据落地。为了避免同时对所有玩家落地造成的热点，可以将Player进程简单分区，每次对其中一个区进行落地，如此轮流。</p>
<p>落地操作交由Player进程，因为我们的绝大部分关于Player的数据都是放在进程字典中的。</p>
<p>Player进程首先遍历其相关的所有Model，取出其中变化的数据，然后更新数据库。</p>
<p>为了模块化，将相关模块描述为：</p>
<ul>
<li>player: 玩家进程，玩家主要业务逻辑处理，消息分发</li>
<li>player_model: 业务逻辑与数据层的中间模块，负责数据初始化和落地</li>
<li>state: 辅助管理所在进程的进程字典，跟踪数据变化。提供查询和更改进程字典，获取进程字典变化数据的接口。</li>
<li>model: 数据层，负责和数据库交互，提供insert, update等基本接口</li>
</ul>
<h2 id="实现机制">实现机制</h2><p>落地实现最核心的两个模块是 player_model 和 state，前者负责Player所有数据的初始化和落地，后者负责管理Player进程字典数据，并且追踪数据的变更状态。</p>
<h3 id="player_model">player_model</h3><p>player_model 建立了业务层到模型层的映射，它仅提供两个最重要的接口：init(PlayerId) 和 save(PlayerId)，分别负责Player所有模块的初始化(数据库 -&gt; 进程字典)和落地(进程字典 -&gt; 数据库)。</p>
<p>在player_model中，有所有Model的相关信息，包括名字，类型和所在模块等等。</p>
<pre><code><span class="function"><span class="title">module_map</span><span class="params">()</span> -&gt;</span>
  [
   <span class="tuple">{player_info, <span class="tuple">{?<span class="variable">INFO_STATE</span>, single}</span>, 
    model_user, ?<span class="function_name">model_record</span>(db_user_info)}</span>,

    .....
    <span class="comment">%{业务逻辑模块, 进程字典中的Key和存储类型 single or list},</span>
    <span class="comment">%{数据存储模块, 数据存储字段}</span>
  ]
</code></pre><p>这样业务逻辑层和Model层被关联起来，对于save来说，最重要的是第二个字段和第三个字段，分别代表该Model在进程字典的状态，以及Model名。save流程主要如下：</p>
<ol>
<li>遍历module_map()，获取各个Model数据在进程字典中变更数据</li>
<li>根据变更状态调用对应Model接口 完成回写</li>
<li>回写完成之后，再重置各个Model的变更状态</li>
</ol>
<p>注意：</p>
<ul>
<li>1，2步是事务性的，所有Model的回写要么都成功，要么都失败，以免各个模块数据之间的数据相关性造成数据不一致的问题。在写入成功后，再次遍历module_map()，重置各个Model的状态。</li>
<li>对于list 和 single两种类型的Model需要分开处理，它们获取变更数据和回写的接口不一样，这可能还需要Model层的支持。这一点在下面state模块介绍中会提到。</li>
</ul>
<p>关于获取Model在进程字典中状态管理，通过state模块来管理。</p>
<h3 id="state">state</h3><p>state模块管理进程字典中的数据，进程字典虽然为简单的Key-Value，但对于我们的Model来说，Value可能为单个记录(如玩家信息)或列表(如玩家建筑列表)。</p>
<p>最简单的情况是，我们单独用一个进程字典，如{Name, state}来获取Model的数据状态，数据状态可分为 origin(初始化) new(创建未保存)， update(更新) delete(删除) 在数据更新时，修改状态，在每次落地同步时，取出所有被修改的Model，并且进行落地同步。之后将数据的状态重置为origin。</p>
<p>然而这种做法对于list类型的Model效率太低，一是业务逻辑上的每次更改都需要改动每个数组，典型的例子是任务列表，玩家对某个任务领奖，导致整个任务列表的拷贝，还可能产生不必要的查找过程。更不可忍受的是，数据落地时，也将重写整个任务列表到数据库。</p>
<p>因此还有另一种方案：将list Model中的记录分开存放，并且分别标记状态，提高查找和回写效率：</p>
<pre><code><span class="comment">%% ------ list Model ----------</span>

<span class="comment">% 存放list中各个key的状态</span>
{<span class="variable">Name</span>, <span class="function_or_atom">list</span>} <span class="arrow">-&gt;</span> [{<span class="function_or_atom">key1</span>, <span class="function_or_atom">update</span>}, {<span class="function_or_atom">key2</span>, <span class="function_or_atom">delete</span>}, ...]

<span class="comment">% 存放列表中各元素的实际数据</span>
{<span class="variable">Name</span>, <span class="variable">Key</span>} <span class="arrow">-&gt;</span>    <span class="variable">Data</span>

<span class="comment">% 存放被删除的元素列表(将不能通过{Name, Key}找到)</span>
{<span class="variable">Name</span>, <span class="function_or_atom">delete</span>} <span class="arrow">-&gt;</span> [<span class="variable">DeleteData1</span>, <span class="variable">DeleteData2</span>, ....]

<span class="comment">%% ------- single Model -------</span>

<span class="comment">% 通过 Name 存取</span>
<span class="variable">Name</span> <span class="arrow">-&gt;</span> <span class="variable">Value</span>

<span class="comment">% 存放Model的更改状态</span>
{<span class="variable">Name</span>, <span class="function_or_atom">state</span>} <span class="arrow">-&gt;</span> <span class="variable">State</span>
</code></pre><p>如此便对Model进行了高效灵活的管理，大大减少了回写数据量。</p>
<p>state封装了进程字典的增删查改操作，并维护进程字典状态。</p>
<p>读取直接通过<code>erlang:get(Name, Key)</code>，对于任务列表来说，这个Key通常是任务ID</p>
<p>更新时：</p>
<p>对于列表:</p>
<ol>
<li>通过{Name, list}检查更新Key的状态</li>
<li>对{Name, Key}执行修改</li>
<li>对于删除操作，还需要将删除的数据放入{Name, delete}中</li>
</ol>
<p>对于单值:</p>
<ol>
<li>通过{Name, state}检查修改状态</li>
<li>对Name执行修改</li>
</ol>
<p>落地相关接口：</p>
<pre><code><span class="xml"></span><span class="perl">% 获取list Model中的变更数据</span><span class="xml">
</span><span class="perl">% 返回: {InsertList, UpdateList, DeleteList}</span><span class="xml">
get_list_changed(Name)
</span><span class="perl">
% 获取single Model中的数据状态</span><span class="xml">
</span><span class="perl">% 返回: {State, Value}</span><span class="xml">
get_single_changed(Name)
</span><span class="perl">
% 重置list Model中的数据状态为origin 并且删除所有状态为<span class="keyword">delete</span>的数据</span><span class="xml">
reset_list(Name)
</span><span class="perl">
% 重置single Model</span><span class="xml">
reset_single(Name)</span>
</code></pre><p>player_mode根据module_map中的条目依次获取变更数据，在使用model模块更新时，可让model模块也提供对single和list两种类型回写的支持。提供各个Model的特殊化处理，如有些Model可以忽略删除列表。</p>
<h2 id="数据加载">数据加载</h2><p>最后再谈谈关于这套框架的数据加载，player_model提供一个init(PlayerId)完成数据的加载，module_map中业务逻辑模块到数据Model层的映射，也是为此准备的。</p>
<p>player_model遍历module_map，调用Model:get(PlayerId)，取出各个Model的数据，然后通过module_map找到对应的业务逻辑模块，回调业务逻辑层初始化函数，该函数可默认指定，比如叫init_callback，每个module_map中的业务逻辑模块都需要提供init_callback进行初始化处理，如同步客户端等等，之后也由init_callback决定是否将数据存往进程字典(通过state模块)。</p>

      
    </div>
    <footer>
<!--        -->
        
  
  <div class="categories">
    <a href="/categories/erlang/">erlang</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/erlang/">erlang</a>
  </div>

        
<!--        -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
<!--   <h1 class="title">留言</h1> -->


    <!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="2015/05/erlang-gameserver-persistence/" data-title="Erlang 服务器落地机制" data-url="http://wudaijun.com/2015/05/erlang-gameserver-persistence/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"wudaijun"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->


  
</section>



</div></div>
  		<aside id="sidebar" class="alignright">
   <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:wudaijun.com">
  </form>
</div> 

  
<div class="widget tag">
  <h3 class="title">分类</h3>
<!--   
	
		<li><a href="/categories/c-c/">c/c++</a><small>5</small></li>
	
  
	
		<li><a href="/categories/erlang/">erlang</a><small>17</small></li>
	
  
	
		<li><a href="/categories/gameserver/">gameserver</a><small>18</small></li>
	
  
	
		<li><a href="/categories/lua/">lua</a><small>1</small></li>
	
  
	
		<li><a href="/categories/network/">network</a><small>3</small></li>
	
  
	
		<li><a href="/categories/python/">python</a><small>1</small></li>
	
  
	
		<li><a href="/categories/tool/">tool</a><small>3</small></li>
	
  
	
		<li><a href="/categories/unity/">unity</a><small>3</small></li>
	
   -->
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/c-c/">c/c++</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/erlang/">erlang</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gameserver/">gameserver</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unity/">unity</a><span class="category-list-count">3</span></li></ul> 
</div>
 


  
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">2016年03月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">2016年02月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">2016年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">2015年12月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">2015年11月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">2015年10月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">2015年09月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">2015年08月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">2015年07月</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">2015年06月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">2015年05月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">2015年04月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">2015年03月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">2015年02月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">2015年01月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">2014年12月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">2014年11月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">2014年10月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">2014年09月</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/c-c/" style="font-size: 15.71px;">c/c++</a> <a href="/tags/erlang/" style="font-size: 20px;">erlang</a> <a href="/tags/firefly/" style="font-size: 11.43px;">firefly</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/kbengine/" style="font-size: 11.43px;">kbengine</a> <a href="/tags/lua/" style="font-size: 17.14px;">lua</a> <a href="/tags/multi-thread/" style="font-size: 12.86px;">multi-thread</a> <a href="/tags/ngserver/" style="font-size: 18.57px;">ngserver</a> <a href="/tags/python/" style="font-size: 12.86px;">python</a> <a href="/tags/skynet/" style="font-size: 14.29px;">skynet</a> <a href="/tags/tcp-ip/" style="font-size: 12.86px;">tcp/ip</a> <a href="/tags/tool/" style="font-size: 11.43px;">tool</a> <a href="/tags/unity/" style="font-size: 12.86px;">unity</a>
  </div>
</div>

</aside>
           <div class="clearfix"></div>
      </div>
  	
   <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 wudaijun
  
</div>
<div class="alignright">
	<a href="https://github.com/pengloo53/light-ch">Hexo theme</a>
</div>
<div class="clearfix"></div></footer>
  <script src="http://libs.baidu.com/jquery/2.1.1/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?380ce5c81e06b297c4a75c0c66825c3d";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<div id="toTop">
	<a href="#">▲</a>
	<a href="#footer">▼</a>
</div>
<!--  -->


</body>
</html>